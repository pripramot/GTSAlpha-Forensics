# สเปก Storage หลักฐาน (Evidence) — การตอบกลับจาก Supabase AI

เอกสารนี้บันทึกทรัพยากรและนโยบายที่ Supabase สร้างตามคำขอ (Chat AI Supabase) สำหรับการอัปโหลดหลักฐานใน GTSAlpha-Forensics

---

## สร้างทรัพยากร

- **ชื่อหมวดหมู่:** หลักฐาน (Evidence)
- **บัคเก็ต Storage:** Evidence (ใช้ชื่อนี้ในโค้ด)

### นโยบาย RLS สำหรับ Storage

| นโยบาย | การใช้งาน |
|--------|-----------|
| หลักฐาน_เจ้าของ_อ่าน | อ่านไฟล์ของตนเอง |
| หลักฐาน_เจ้าของ_แทรก | อัปโหลด (insert object) |
| อัปเดตเจ้าของหลักฐาน | อัปเดตวัตถุของตนเอง |
| หลักฐาน_เจ้าของ_ลบ | ลบวัตถุของตนเอง |

### ตัวกระตุ้น (Trigger)

- **ชื่อ:** `trg_validate_evidence_upload`
- **ฟังก์ชัน:** `public.validate_evidence_upload`
- ใช้ตรวจสอบข้อจำกัดการอัปโหลด (ประเภทไฟล์, ขนาด)

### ตารางเมตาเดต้า

- **ตาราง:** `public.evidence_uploads`
- **นโยบาย RLS:** ชื่อเดียวกับ Storage (หลักฐาน_เจ้าของ_อ่าน, หลักฐาน_เจ้าของ_แทรก, อัปเดตเจ้าของหลักฐาน, หลักฐาน_เจ้าของ_ลบ)
- **แนะนำดัชนี:** `user_id`, `case_id`, `uploaded_at` เพื่อประสิทธิภาพ

---

## สิ่งที่บังคับใช้

| รายการ | ค่า |
|--------|-----|
| ประเภทไฟล์ | JPEG, PNG, PDF, MP4 |
| ขนาดไฟล์สูงสุด | 50 MB ต่อไฟล์ |
| การเข้าถึง | ผู้ใช้แต่ละคน อัปโหลด/อ่าน/อัปเดต/ลบ เฉพาะไฟล์ของตนเองในบัคเก็ต Evidence |

### โครงสร้างโฟลเดอร์ (บังคับโดย RLS)

โฟลเดอร์แรกต้องเท่ากับ `auth.uid()` ของผู้ใช้ (รูปแบบข้อความ)

**ตัวอย่างเส้นทาง:** `<auth.uid()>/case-123/photo.jpg`

---

## วิธีใช้งานในแอป

### รูปแบบเส้นทางการอัปโหลด

```
path = ${user.id}/${caseId}/${filename}
```

**ตัวอย่าง:** `a1b2c3d4-uuid/user-id/case-456/evidence-photo.jpg`

### การเรียกใช้ Supabase Storage (ฝั่งไคลเอ็นต์)

- **ถัง (bucket):** `Evidence` (หรือชื่อที่ Supabase สร้างให้ เช่น `evidence`)
- **หมายเหตุ:** ใช้เส้นทางตามรูปแบบด้านบนเท่านั้น

### การจัดเก็บเมตา (ถ้าใช้)

แทรกแถวลงใน `public.evidence_uploads`:

| คอลัมน์ | ค่า |
|---------|-----|
| `user_id` | `auth.uid()` |
| `case_id` | UUID ของเคส (ไม่บังคับ) |
| `path` | คีย์จัดเก็บเดียวกัน (path ใน Storage) |
| `content_type` | จาก response การอัปโหลด |
| `size_bytes` | จาก response การอัปโหลด |

---

## หมายเหตุและข้อสมมติฐาน

- การตรวจสอบขนาดและประเภท MIME อ่านจาก `storage.objects.metadata` เมื่อมีข้อมูล; `supabase-js` กำหนดค่าเหล่านี้ในการอัปโหลดมาตรฐาน หากไม่มี MIME จะใช้การตรวจสอบตามนามสกุลไฟล์เป็นทางเลือกสำรอง
- RLS กำหนดให้ใช้รูปแบบเส้นทางนี้ หากมีบทบาทแอปหรือเคสร่วมกันในภายหลัง สามารถเพิ่มนโยบายตามบทบาท/องค์กรควบคู่กับนโยบายเจ้าของได้
- หากต้องการเปลี่ยนชื่อบัคเก็ตเป็น `forensics-uploads` หรือรูปแบบโฟลเดอร์อื่น (ตามคดี/องค์กร) ให้แจ้ง Supabase เพื่ออัปเดตนโยบายและทริกเกอร์

---

*อ้างอิง: การตอบกลับจาก Supabase AI (Chat) — บันทึกไว้สำหรับทีมและ implementation ฝั่ง renderer*
